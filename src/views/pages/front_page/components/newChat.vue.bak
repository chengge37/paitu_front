<template>
  <div>
    <div class="chat-wrap" v-if="showIM">
      <!-- èŠå¤©å…¥å£å°æµ®çª— -->
      <div class="enter" @click="openMenber" v-if="!isShowList">
        <!-- <span></span> -->
        <i class="el-icon-chat-dot-round animated" :class="[{flash:hasNew,new:hasNew}]"></i>
      </div>
      <!-- èŠå¤©å¥½å‹åˆ—è¡¨ -->
      <div class="menbers-list-wrap" v-show="isShowList">
        <div class="person-info">
          <div class="first-row">
            <!-- <span class="my-name">{{user_data.nick}}</span> -->
            <span class="my-name">èŠå¤©åˆ—è¡¨</span>
            <i class="el-icon-circle-close" @click="closeMenber"></i>
          </div>
        </div>
        <div class="menbers-list">
          <div class="menber-wrap" v-if="menberList.length>0">
            <div class="menber" @click="clickMenberList(item)" v-for="(item,index) in menberList" :key="index">
              <div class="menber-left">
                <img :src="picDeal(item)" alt="">
              </div>
              <div class="menber-right">
                <span class="menber-name">{{nameDeal(item)}}</span>
                <span class="last-msg">{{item.lastMsg.summary}}</span>
              </div>
              <div class="new-count" v-show="item.unreadMessagesCount>0">{{item.unreadMessagesCount}}</div>
            </div>
          </div>
          <div class="no-menber" v-else>æš‚æ— å¯¹è¯</div>
        </div>
      </div>
      <!-- èŠå¤©å¯¹è¯æ¶ˆæ¯çª—å£ -->
      <!-- <div class="chat-window" draggable="true" @drag="dragging" @dragstart="startDrag" @dragend="endDrag" v-if="isShowChat" :class="{'max-window':isMaxWindow}"> -->
      <div class="chat-window" v-if="isShowChat" :class="{'max-window':isMaxWindow}" @click="clickChatWindow">
        <!-- å·¦è¾¹çš„å‘èµ·èŠå¤©æˆå‘˜åˆ—è¡¨ -->
        <div class="window-left" v-if="chattingMenbers.length>1">
          <div class="chat-menber" @click="clickMenberList(item)" v-for="(item,index) in chattingMenbers" :key="index" :class="{'chat-menber-checked':item.id==curChatId}">
            <img :src="picDeal(item)" alt="">
            <span class="menber-name">{{nameDeal(item)}}</span>
            <i class="el-icon-error" @click.stop="delChatting(item,index)"></i>
          </div>
        </div>
        <!-- å³è¾¹çš„èŠå¤©çª—å£ä¸»ä½“ -->
        <div class="window-right">
          <div class="chat-top" @mousedown="boxMove($event)">
            <!-- èŠå¤©å¯¹è±¡çš„å¤´åƒåå­— -->
            <div class="menber-info">
              <!-- <img src="http://img1.imgtn.bdimg.com/it/u=2357912857,682090914&fm=26&gp=0.jpg" alt=""> -->
              <img :src="chatObj.avatar?(chatObj.avatar.indexOf('http')==-1?$qiniuHost+chatObj.avatar:chatObj.avatar):'https://pic.paitume.com/images/male.png'" alt="">
              <span class="menber-name">{{chatObj.name}}</span>
            </div>
            <!-- æ§åˆ¶çª—å£å¤§å°å…³é—­çš„æŒ‰é’® -->
            <div class="window-operation">
              <i v-if="!isMaxWindow" class="el-icon-minus" @click.stop="minWindow"></i>
              <i v-if="!isMaxWindow" class="el-icon-full-screen" @click="maxWindow"></i>
              <i v-else class="el-icon-copy-document" @click="cancelMaxWindow"></i>
              <i class="el-icon-circle-close" @click="closeChatWindow"></i>
            </div>
          </div>
          <!-- æ¶ˆæ¯å±•ç¤ºæ¡† -->
          <div class="message-box" :class="{'max-message-box':isMaxWindow}" ref="msgBox">
            <div class="message" v-for="(item,index) in msgList" :key="index" :class="{'my-message':item.from==user_data.id}">
              <!-- <img :src="picDeal(item)" alt=""> -->
              <img class="avatar" :src="myAvatar" alt="" v-if="item.from==user_data.id">
              <img class="avatar" :src="hisAvatar" alt="" v-else>
              <div class="msg-body">
                <div class="name-time">
                  <span class="name">{{item.from==user_data.id?creatorObj.name:chatObj.name}}</span>
                  <span class="time">{{dealTime(item.timestamp)}}</span>
                </div>
                <div class="content">
                  <span class="text" v-if="item.type==-1">{{item.text}}</span>
                  <div class="file" v-else>
                    <div class="file-link">
                      <!-- å›¾ç‰‡ç±»å‹æ¶ˆæ¯ -->
                      <img v-if="item.type==-2" @click="openUrl" :src="item._lcfile.url" alt="">
                      <!-- è§†é¢‘ç±»å‹æ¶ˆæ¯ -->
                      <video controls v-if="item.type==-4" :src="item._lcfile.url"></video>
                      <!-- éŸ³é¢‘ç±»å‹æ¶ˆæ¯ -->
                      <audio controls v-if="item.type==-3" :src="item._lcfile.url"></audio>
                      <!-- wordï¼Œexcelï¼Œpptï¼Œtxtç­‰æ–‡ä»¶ -->
                      <i v-if="item.type==-6" class="el-icon-document"></i>
                      <a target="_blank" :href="item._lcfile.url">{{item._file.attributes.name}}</a>
                    </div>
                    <span class="decription">{{item.text}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- å‘é€æ–‡ä»¶ï¼ŒèŠå¤©è®°å½•ç­‰æ“ä½œæŒ‰é’® -->
          <div class="send-operation">
            <span class="send-file">
              <i class="el-icon-folder-opened"></i>
              <input ref="inputFile" type="file" @change="selectFile">
            </span>
            <div class="emoji-wrap" @click.stop="clickEmojiBox">
              <span @click="openEmoji">ğŸ˜„</span>
              <div class="emoji-box" v-if="showEmoji">
                <div class="emoji-group" v-for="(item,index) in emojiArr" :key="index">
                  <p class="emoji-class">{{item.name}}</p>
                  <div class="emoji-list">
                    <span class="emoji-item" v-for="(each,j) in item.emojis" :key="j" @click="selectEmoji(each)">{{each}}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="file-info" v-if="fileObj">
              <span class="file-name">{{fileObj.name}}</span>
              <span class="cancel-btn" @click="cancelFile">å–æ¶ˆè¯¥æ–‡ä»¶</span>
              <!-- <i class="el-icon-close" @click="cancelFile"></i> -->
            </div>
          <!-- <el-upload
              class="upload-demo"
              :on-change="handleChange"
              :file-list="fileList">
              <el-button size="small" type="primary">ç‚¹å‡»ä¸Šä¼ </el-button>
            </el-upload> -->

            <span class="history-label" @click="toggleHistory"><i class="el-icon-time"></i> èŠå¤©è®°å½•</span>
          </div>
          <!-- æ¶ˆæ¯è¾“å…¥åŒºåŸŸ -->
          <div class="input-area">
            <el-input
              type="textarea"
              placeholder="è¯·è¾“å…¥å†…å®¹,å¯æŒ‰ã€ Enter ã€‘å‘é€"
              @keydown.enter.native="preventChangeRow($event)"
              @keyup.enter.native="sendMessage()" 
              v-model="inputContent">
            </el-input>
          </div>
          <!-- å…³é—­å‘é€æŒ‰é’® -->
          <div class="bottom-btn">
            <span @click.stop="closeChatWindow">å…³é—­</span>
            <span @click.stop="sendMessage">å‘é€</span>
          </div>
        </div>
      </div>
      <!-- èŠå¤©çª—å£æœ€å°åŒ–åçš„å›¾æ ‡ -->
      <div class="small-chat" v-if="isMinWindow" @click="returnChat">
        <img :src="chatObj.avatar" alt="">
        <span class="menber-name">{{chatObj.name}}</span>
      </div>
      <!-- èŠå¤©è®°å½•çª—å£ -->
      <div class="history-box animated" v-if="isShowHistory" :class="[{'max-history':isMaxHistory,fadeInUpBig:isShowHistory}]">
        <div class="history-top">
          <span>ä¸ {{chatObj.name}} çš„èŠå¤©è®°å½•</span>
          <div class="history-box-operation">
            <i v-if="!isMaxHistory" class="el-icon-minus" @click="minHistory"></i>
            <i v-if="!isMaxHistory" class="el-icon-full-screen" @click="maxHistory"></i>
            <i v-else class="el-icon-copy-document" @click="cancelMaxHistory"></i>
            <i class="el-icon-circle-close" @click="toggleHistory"></i>
          </div>
        </div>
        <div class="history-message-box" ref="historyMsg">
          <p class="tip">æ¸©é¦¨æé†’ï¼šç›®å‰åªèƒ½æŸ¥è¯¢åˆ°æœ€è¿‘åŠå¹´çš„æ¶ˆæ¯è®°å½•</p>
          <div class="message" v-for="(item,index) in historyMsgList" :key="index" :class="{'my-message':item.from==user_data.id}">
            <!-- <img :src="picDeal(item)" alt=""> -->
            <img class="avatar" :src="myAvatar" alt="" v-if="item.from==user_data.id">
            <img class="avatar" :src="hisAvatar" alt="" v-else>
            <div class="msg-body">
              <div class="name-time">
                <span class="name">{{item.from==user_data.id?creatorObj.name:chatObj.name}}</span>
                <!-- <span class="time">{{dealTime(item.from==user_data.id?item.timestamp:item.deliveredAt)}}</span> -->
                <span class="time">{{dealTime(item.timestamp)}}</span>
              </div>
              <div class="content">
                <span class="text" v-if="item.type==-1">{{item.text}}</span>
                <div class="file" v-else>
                  <div class="file-link">
                    <!-- å›¾ç‰‡ç±»å‹æ¶ˆæ¯ -->
                    <img v-if="item.type==-2" @click="openUrl" :src="item._lcfile.url" alt="">
                    <!-- è§†é¢‘ç±»å‹æ¶ˆæ¯ -->
                    <video controls v-if="item.type==-4" :src="item._lcfile.url"></video>
                    <!-- éŸ³é¢‘ç±»å‹æ¶ˆæ¯ -->
                    <audio controls v-if="item.type==-3" :src="item._lcfile.url"></audio>
                    <!-- wordï¼Œexcelï¼Œpptï¼Œtxtç­‰æ–‡ä»¶ -->
                    <i v-if="item.type==-6" class="el-icon-document"></i>
                    <a target="_blank" :href="item._lcfile.url">{{item._file.attributes.name}}</a>
                  </div>
                  <span class="decription">{{item.text}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- å†å²èŠå¤©è®°å½•æœ€å°åŒ–åçš„å›¾æ ‡ -->
      <div class="small-history" v-if="isMinHistory">
        <span>èŠå¤©è®°å½•</span>
        <i class="el-icon-copy-document" @click="toggleHistory"></i>
        <i class="el-icon-close" @click="closeMinHistory"></i>
      </div>
    </div>
    <!-- è¿·ä½ ç™»å½• -->
    <login :reg="true" :openlogin="showLogin"  @closed="closeLogin"></login>
  </div>
</template>

<script>
// import AV, { Object, Conversation } from "leancloud-storage";
import { Object, Conversation } from "leancloud-storage";
import { Realtime,TextMessage,Event } from "leancloud-realtime";
import { TypedMessagesPlugin,ImageMessage,FileMessage, AudioMessage, VideoMessage } from "leancloud-realtime-plugin-typed-messages";
import { mapGetters } from "vuex";
import { getRequest } from '@/util/httpUtil'
import {AV} from '@/util/av.js'
import { store } from "@config/api.js"
import { storage } from '@/util/storage'
import { async } from 'q';
import Login from "./minilogin";
import Emoji from './emoji/emojiData'

  export default {
    data(){
      return{
        showIM:false,
        isShowList:false,
        isShowChat:false,
        isMaxWindow:false,
        isMinWindow:false,
        inputContent:'',
        chattingMenbers:[],//èŠå¤©çª—ä½“å·¦ä¾§å‘èµ·çš„èŠå¤©æˆå‘˜
        menberList:[],//æˆå‘˜åˆ—è¡¨
        curItem:null,
        isShowHistory:false,
        isMinHistory:false,
        isMaxHistory:false,
        initX:null,
        initY:null,
        fileObj:null,
        fileName:null,
        initObj:null,
        creatorObj:{
          id:null,
          name:null,
          avatar:null
        },
        chatObj:{},
        msgList:[],
        historyMsgList:[],
        conversationObj:null,
        sentFile:null,
        curChatId:null,
        hasNew:false,
        showLogin:false,
        // textMsgObj:null,
        // fileMsgObj:null,
        emojiArr:[],
        showEmoji:false,
        myAvatar:'',
        hisAvatar:''
      }
    },
    components: {
      Login
    },
    created() {
      this.emojiArr=Emoji
      console.warn(this.user_data,'èŠå¤©ç”¨åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯')
      if(this.user_data){
        // this.showIM=true
        this.creatorObj.id=this.user_data.id
        this.creatorObj.name=this.user_data.nick
        this.creatorObj.avatar=this.user_data.avatar
        if(!this.creatorObj.avatar){
          this.creatorObj.avatar='https://pic.paitume.com/images/male.png'
        }
      }
    },
    mounted(){
      console.warn('mountedæ‰§è¡Œ',Emoji)
      if(this.user_data){
        this.init(this.user_data.id)
      }
      // console.warn(this.user_data,'èŠå¤©ç”¨åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯')
      // if(this.user_data){
      //   this.showIM=true
      //   this.creatorObj.id=this.user_data.id
      //   this.creatorObj.name=this.user_data.nick
      //   this.creatorObj.avatar=this.user_data.avatar
      //   if(!this.creatorObj.avatar){
      //     this.creatorObj.avatar='https://pic.paitume.com/images/male.png'
      //   }
      //   this.init(this.user_data.id)
      // }
    },
    updated(){
      // this.$refs.msgBox.scrollTo(0,this.$refs.msgBox.scrollHeight);
    },

    computed: {
      ...mapGetters(["user_data"])
    },
    watch:{
      user_data(val){
        console.warn('userdataæœ‰å˜åŒ–',val)
        if(val){
          // this.showIM=true
          // this.init(val.id)
        }else{
          this.showIM=false
          this.isShowList=false
          this.isShowChat=false
          this.isMaxWindow=false
          this.isMinWindow=false
          this.isShowHistory=false
          this.isMinHistory=false
          this.isMaxHistory=false
        }
      },
      "user_data.id":{
          handler:function(newval,oldval){
            if(newval){
              this.init(newval)
            }else{
              this.showIM=false
              this.isShowList=false
              this.isShowChat=false
              this.isMaxWindow=false
              this.isMinWindow=false
              this.isShowHistory=false
              this.isMinHistory=false
              this.isMaxHistory=false
            }
          }
      }
    },
    filters:{
      
    },
    methods:{
      // ç‚¹å‡»èŠå¤©çª—å£çš„æ—¶å€™æ‰“å¼€çš„è¡¨æƒ…åŒ…ç›’å­è¦å…³é—­
      clickChatWindow(){
        console.warn('ç‚¹å‡»äº†')
        this.showEmoji=false
      },
      // ç‚¹å‡»è¡¨æƒ…åŒ…ç›’å­
      clickEmojiBox(){
        this.showEmoji=true
      },
      // æ‰“å¼€è¡¨æƒ…åŒ…ç›’å­
      openEmoji(){
        this.showEmoji=true
      },
      // é€‰æ‹©è¡¨æƒ…
      selectEmoji(item){
        this.inputContent+=item
      },
      // å…³é—­è¿·ä½ ç™»å½•
      closeLogin(){
        this.showLogin=false
      },
      // IMåˆå§‹åŒ–ç™»å½•,æ‹¿ç”¨æˆ·çš„IDæ¥åˆ›å»ºIMClientå¯¹è±¡
      init(userId){
        let realtime = new Realtime({
          appId: 'FopplxMIbowedHTR8yseJjGs-gzGzoHsz',
          appKey: '0MWelPMmKtpDIiEJAP871OP1',
          plugins: [TypedMessagesPlugin] // æ³¨å†Œå¯Œåª’ä½“æ¶ˆæ¯æ’ä»¶
        });
        //  ç”¨ç”¨æˆ·çš„idä½œä¸º clientId æ¥ç™»å½•å³æ—¶é€šè®¯æœåŠ¡
        let signatureFactory = function() {
          return getRequest(`/user/getLeancloudSign?name=${userId}`)
          .then(resq => {
            let signature = resq.signature;
            let timestamp = parseInt(resq.timestamp);
            let nonce = resq.nonce;

            return {
              signature: signature,
              timestamp: timestamp,
              nonce: nonce
            };
          })
          .catch(err => {
            return Promise.reject(err);
          });
        };
        realtime.createIMClient(userId, {
          signatureFactory: signatureFactory
        })
        .then((obj)=> {
          // æˆåŠŸç™»å½•åè·å–åˆ°è¿™ä¸ªclientå¯¹è±¡
          this.initObj=obj
          this.getConversations(obj)
          this.listenNewMsg(obj)
          this.showIM=true
          // this.listenUnread(obj)
          console.warn(this.initObj,'ç™»å½•æˆåŠŸå')
        }).catch(err=>{console.error(err,'IMç™»å½•å¤±è´¥')})
      },
      // è·å–æ‰€æœ‰å¯¹è¯
      getConversations(obj){
        var _this=this
        var query=obj.getQuery()
        query.find().then(conversations=>{
          this.menberList=[]
          console.warn(conversations,'æ‰€æœ‰çš„å¯¹è¯')
          conversations.forEach((item,index)=>{
            item.queryMessages({
                limit: 10,
            }).then((messages)=> {
              if(item.members.length!=1&&messages.length!=0){
                this.$set(item,'lastMsg',messages[messages.length-1])
                this.menberList.push(item)
                this.menberList=this.menberList.sort((a,b)=>{
                  return b._updatedAt.valueOf()-a._updatedAt.valueOf()
                })
              }
            }).catch(console.error.bind(console));
          })
          console.warn(this.menberList,'å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ')
        }).catch(err=>{console.error(err)})
      },
      // ç›‘å¬æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯
      listenNewMsg(obj){
        // å½“å‰ç”¨æˆ·æ”¶åˆ°äº†æŸä¸€æ¡æ¶ˆæ¯ï¼Œå¯ä»¥é€šè¿‡å“åº” Event.MESSAGE è¿™ä¸€äº‹ä»¶æ¥å¤„ç†ã€‚
        obj.on(Event.MESSAGE, (message, conversation)=> {
          // å½“ä¸€å°ç”µè„‘ç™»å½•å¤šä¸ªè´¦æˆ·çš„æ—¶å€™å¯èƒ½ä¼šå‡ºç°è‡ªå·±å‘æ¶ˆæ¯å´è§¦å‘æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶ï¼Œè¿˜ä¼šé€ æˆå¯¹æ–¹å’Œè‡ªå·±æ¶ˆæ¯é”™ä¹±çš„æƒ…å†µ
          if(message.from==this.user_data.id){//åˆ¤æ–­å¦‚æœæ˜¯è‡ªå·±çš„æ¶ˆæ¯å°±ä¸å¾€ä¸‹æ‰§è¡Œæ¥è§„é¿é”™è¯¯
            return
          }
          console.info(message,'æ–°æ¶ˆæ¯',conversation,'æ¶ˆæ¯å¯¹è±¡',this.isShowChat,'èŠå¤©çª—å£')
          // åœ¨æ­¤å¤„å¤„ç†å±•ç¤ºæœªè¯»æ¶ˆæ¯
          if(this.isShowChat){
            // èŠå¤©çª—ä½“ä¸€æ‰“å¼€ï¼Œé‚£é‡Œé¢çš„æ¶ˆæ¯å°±å…¨éƒ½æ ‡è®°ä¸ºå·²è¯»
            this.conversationObj.read().then(res=>{
              console.info(res,'æ¥æ”¶æ¶ˆæ¯æ ‡ä¸ºå·²è¯»')
            }).catch(err=>{console.error(err)})
          }
          // å¦‚æœæˆå‘˜åˆ—è¡¨ä¸€å¼€å§‹è¿˜æ²¡æœ‰æ•°æ®
          if(this.menberList.length==0){
            this.menberList.push(conversation)
          }else{
            let canPush=this.menberList.every((item,index)=>{
              return item.id!=conversation.id
            })
            if(canPush&&conversation.members.length!=1){
              this.menberList.unshift(conversation)
            }
          }
          this.msgList.push(message)
          this.scrollToBottom()
          // è·å–è¯¥conversationæœ€åä¸€æ¡æ¶ˆæ¯
          this.menberList.forEach((item,index)=>{
            if(item.id==conversation.id){
              this.$set(item,'lastMsg',message)
              console.warn(item,'ç›‘å¬æ”¶åˆ°æ–°æ¶ˆæ¯ï¼Œæˆå‘˜åˆ—è¡¨ä¸­çš„æœ€åä¸€æ¡æ¶ˆæ¯')
            }
          })
          this.hasNewMsg()
          // this.getThousandNews(conversation)
          // this.getConversations(obj)
          
        })
        // ç›‘å¬æœªè¯»æ¶ˆæ¯ï¼Œåªè¦æœ‰æœªè¯»æ¶ˆæ¯å°±ä¼šè§¦å‘ï¼Œä¸è¦æ‰‹åŠ¨æ‰“å°unreadMessagesCountï¼Œå¾—åˆ°çš„ç»“æœå¯èƒ½æ˜¯ç¬é—´å€¼ï¼Œè¿™æ˜¯SDKçš„é—®é¢˜
        // åªè¦ç›‘å¬åˆ°æœ‰æœªè¯»æ¶ˆæ¯å°±è°ƒç”¨å‡½æ•°å°±å¯ä»¥äº†
        obj.on("unreadmessagescountupdate", (conversations)=> {
          this.hasNewMsg()
        });
      },
      // èŠå¤©å›¾æ ‡æ˜¯å¦é—ªçƒæé†’ç”¨æˆ·æœ‰æ–°çš„æ¶ˆæ¯
      hasNewMsg(){
        console.warn('åˆ¤æ–­æ˜¯å¦æœ‰æ–°æ¶ˆæ¯')
        this.hasNew=this.menberList.some(item=>{
          return item.unreadMessagesCount!=0
        })
      },
      // ç‚¹å‡»èŠå¤©æµ®çª—æ‰“å¼€èŠå¤©å¥½å‹åˆ—è¡¨
      openMenber(){
        console.warn('è§¦å‘')
        this.$nextTick(()=>{
          this.isShowList=true
        })
      },
      // å…³é—­èŠå¤©å¥½å‹åˆ—è¡¨
      closeMenber(){
        this.isShowList=false  
        console.warn('è§¦å‘å…³é—­uiæ–‡æ¡ˆå°±å‡ å—è…¹è‚Œå’–å•¡å¤§å¸ˆé‡‘å…‹æ‹‰åˆ†é‡æ¥å£çš„æ’’666',this.isShowList)
      },
      // æœ€å°åŒ–èŠå¤©å¯¹è¯æ¡†æˆå°æµ®çª—
      minWindow(){
        this.showEmoji=false
        this.isShowChat=false
        this.isMinWindow=true
        this.$nextTick(()=>{
          document.getElementsByClassName('small-chat')[0].style.top=null
          document.getElementsByClassName('small-chat')[0].style.left=null
        })
      },
      // æœ€å¤§åŒ–èŠå¤©å¯¹è¯æ¡†
      maxWindow(){
        this.isMaxWindow=true
        document.querySelector('body').setAttribute('style', 'overflow:hidden')
        this.$nextTick(()=>{
          document.getElementsByClassName('max-window')[0].style.top=null
          document.getElementsByClassName('max-window')[0].style.left=null
        })
      },
      // å–æ¶ˆæœ€å¤§åŒ–èŠå¤©å¯¹è¯æ¡†
      cancelMaxWindow(){
        this.isMaxWindow=false
				document.querySelector('body').setAttribute('style', 'overflow-y:scroll')
      },
      // ç‚¹å‡»èŠå¤©å¥½å‹åˆ—è¡¨ä¸­çš„æŸä¸ªäººå‘èµ·èŠå¤©
      clickMenberList(conversation){
        this.chatObj=conversation.creator==this.user_data.id?{...conversation._attributes.chatToObj}:{...conversation._attributes.creatorObj}
        if(!this.chatObj.avatar){
          this.chatObj.avatar='https://pic.paitume.com/images/male.png'
        }
        this.conversationObj=conversation

        console.log('####conversation.creator = ',conversation);
        if(conversation.system){
        //ç³»ç»Ÿæ¶ˆæ¯ ï¼ˆæ¥è‡ªserver RESTï¼‰
            console.log('è‡ªå·±',this.user_data);
            this.myAvatar= this.user_data.avatar == undefined?'https://pic.paitume.com/images/male.png':this.user_data.avatar;
            //this.user_data.avatar
            this.hisAvatar=conversation._attributes.creatorObj.avatar
        } else {
            this.myAvatar=conversation.creator==this.user_data.id?conversation._attributes.creatorObj.avatar:conversation._attributes.chatToObj.avatar
            this.hisAvatar=conversation.creator==this.user_data.id?conversation._attributes.chatToObj.avatar:conversation._attributes.creatorObj.avatar
        }
      
        if(this.myAvatar){
          if(this.myAvatar.indexOf('http')==-1){
            this.myAvatar=this.$qiniuHost+this.myAvatar
          }
        }else{
          this.myAvatar='https://pic.paitume.com/images/male.png'
        }
        if(this.hisAvatar){
          if(this.hisAvatar.indexOf('http')==-1){
            this.hisAvatar=this.$qiniuHost+this.hisAvatar
          }
        }else{
          this.hisAvatar='https://pic.paitume.com/images/male.png'
        }


        this.isShowChat=true
        this.isMaxWindow=false
        this.isMinWindow=false
        this.curChatId=conversation.id
        // æ­¤æ—¶éœ€è¦è·å–å†å²èŠå¤©è®°å½•
        this.getThousandNews(conversation)
        // è·å–å†å²èŠå¤©è®°å½•
        var messageIterator = this.conversationObj.createMessagesIterator({ limit: 1000 });
        this.historyMsgList=[]
        this.historyIterator(messageIterator,this.conversationObj,1)
        // èŠå¤©çª—ä½“ä¸€æ‰“å¼€ï¼Œé‚£é‡Œé¢çš„æ¶ˆæ¯å°±å…¨éƒ½æ ‡è®°ä¸ºå·²è¯»
        this.initObj.getConversation(conversation.id).then(function(res) {
          res.read().then(res=>{
            console.info(res,'æ ‡ä¸ºå·²è¯»')
          }).catch(err=>{console.error(err)})
        }).catch(console.error.bind(console));
        
        // åˆ¤æ–­å·¦ä¾§çš„æ­£åœ¨èŠå¤©çš„æˆå‘˜åˆ—è¡¨æ˜¯å¦è¦æ·»åŠ è¿™ä¸€ä¸ªconversation
        let canPush=this.chattingMenbers.every((item,index)=>{
          return item.id!=conversation.id
        })
        if(canPush){
          this.chattingMenbers.push(conversation)
          // this.getConversations(this.initObj)
        }
        // æŠŠæ‰“å¼€çš„é‚£ä¸ªä¼šè¯çš„æœªè¯»æ¶ˆæ¯ç½®é›¶
        this.$set(conversation,'unreadMessagesCount',0)
      },
      // å‘èµ·å’ŒæŸäººçš„èŠå¤©
      chatTo(chatObj){
        if(!this.user_data){
          // this.$message.warning('è¯·å…ˆç™»å½•')
          // this.$router.push('/login')
          this.showLogin=true
          return
        }
        if(!chatObj.id){
          this.$message.error('å‡ºé”™äº†ï¼ŒèŠå¤©å¯¹è±¡ç¼ºå°‘id')
          return
        }
        this.chatObj={...chatObj}
        if(!this.chatObj.avatar){
          this.chatObj.avatar='https://pic.paitume.com/images/male.png'
        }
        // åˆ›å»ºä¸ chatObj ä¹‹é—´çš„èŠå¤©å¯¹è¯
        this.initObj.createConversation({
          // æŒ‡å®šå¯¹è¯çš„æˆå‘˜é™¤äº†å½“å‰ç”¨æˆ·ä¹‹å¤–ï¼Œè¿˜æœ‰ chatObj
          members: [this.chatObj.id],
          // å¯¹è¯åç§°
          // name: 'Tom & Jerry',
          unique: true,//è¯¥å‚æ•°æŒ‡å®šå¯¹è¯æ˜¯å”¯ä¸€çš„ï¼Œåƒä¸‡ä¸è¦åˆ é™¤ï¼Œå¦åˆ™æ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è¯å“ªæ€•èŠå¤©çš„æˆå‘˜ä¸€æ ·,
          creatorObj:this.creatorObj,
          chatToObj:{...this.chatObj}
          // creatorName:this.creatorObj.name,
          // creatorAvatar:this.creatorObj.avatar,
          // chatName:chatObj.name,
          // chatAvatar:chatObj.avatar
        }).then(conversation=>{
          this.conversationObj=conversation//ä¿å­˜å½“å‰çš„èŠå¤©å¯¹è¯å¯¹è±¡
          console.warn(conversation,'å½“å‰åˆ›å»ºçš„conversationå¯¹è±¡')
          // this.isShowChat=true
          this.isMaxWindow=false
          this.isMinWindow=false
          this.curChatId=conversation.id
          // èŠå¤©çª—ä½“ä¸€æ‰“å¼€ï¼Œé‚£é‡Œé¢çš„æ¶ˆæ¯å°±å…¨éƒ½æ ‡è®°ä¸ºå·²è¯»
          conversation.read().then(res=>{
            console.info(res,'æ ‡ä¸ºå·²è¯»')
          }).catch(err=>{console.error(err)})
          // åˆ¤æ–­å·¦ä¾§çš„æ­£åœ¨èŠå¤©çš„æˆå‘˜åˆ—è¡¨æ˜¯å¦è¦æ·»åŠ è¿™ä¸€ä¸ªconversation
          let canPush=this.chattingMenbers.every((item,index)=>{
            return item.id!=conversation.id
          })
          if(canPush){
            this.chattingMenbers.push(conversation)
            // this.getConversations(this.initObj)
          }
          // æ­¤æ—¶éœ€è¦è·å–å†å²èŠå¤©è®°å½•
          this.getThousandNews(conversation)
          // æŠŠæ‰“å¼€çš„é‚£ä¸ªä¼šè¯çš„æœªè¯»æ¶ˆæ¯ç½®é›¶
          this.menberList.forEach(item=>{
            if(Conversation.id=item.id){
              this.$set(item,'unreadMessagesCount',0)
            }
          })
          this.hasNewMsg()
        });
      },
      // é˜»æ­¢å›è½¦æ¢è¡Œå¿…é¡»åœ¨å›è½¦é”®æŒ‰ä¸‹keydownçš„æ—¶å€™é˜»æ­¢
      preventChangeRow(e){
        e.preventDefault();
      },
      // å‘é€æ¶ˆæ¯
      sendMessage(){
        this.showEmoji=false
        var _this=this
        // å‘é€æ–‡ä»¶ç±»å‹æ¶ˆæ¯
        if(this.fileObj){
          console.warn(this.fileObj,'è¦å‘é€çš„æ–‡ä»¶')
          var file = new AV.File(this.fileObj.name, this.fileObj);
          console.warn(file,'AVåˆå§‹åŒ–File')
          file.save().then(function() {
            if(_this.fileObj.type.indexOf('image')!=-1){
              // å‘é€å›¾ç‰‡
              var message = new ImageMessage(file);
            }else if(_this.fileObj.type.indexOf('video')!=-1){
              // å‘é€è§†é¢‘
              var message = new VideoMessage(file);
            }else if(_this.fileObj.type.indexOf('audio')!=-1){
              // å‘é€éŸ³é¢‘
              var message = new AudioMessage(file);
            }else{
              // å‘é€å…¶ä»–æ–‡ä»¶ç±»å‹
              var message = new FileMessage(file);
            }
            if(_this.inputContent){
              message.setText(_this.inputContent);
            }
            return _this.conversationObj.send(message);
          }).then(function(msg) {
            console.log('æ–‡ä»¶å‘é€æˆåŠŸ',msg);
            _this.decription=msg.text
            // å¦‚æœæˆå‘˜åˆ—è¡¨ä¸€å¼€å§‹è¿˜æ²¡æœ‰æ•°æ®
            if(_this.msgList.length==0){
              _this.menberList.push(_this.conversationObj)
            }
            // æŠŠæ¶ˆæ¯æ¨å…¥messageList
            _this.msgList.push(msg)
            // æ›´æ–°æˆå‘˜åˆ—è¡¨ä¸­çš„æœ€åä¸€æ¡æ¶ˆæ¯
            _this.menberList.forEach((item,index)=>{
              if(item.id==_this.conversationObj.id){
                _this.$set(item,'lastMsg',msg)
                console.warn(item,'æ–‡ä»¶ç±»å‹æœ€åä¸€æ¡æ¶ˆæ¯')
              }
            })
            console.warn(_this.msgList,'æ‰€æœ‰æ¶ˆæ¯888')
            // _this.conversationObj.queryMessages({
            //     limit: 1000, 
            // }).then((messages)=> {
            //   console.warn(messages[messages.length-1],'æœ€åä¸€æ¡æ–‡ä»¶æ¶ˆæ¯')
            //   _this.menberList.forEach((item,index)=>{
            //     if(item.id==_this.conversationObj.id){
            //       _this.$set(item,'lastMsg',messages[messages.length-1])
            //     }
            //   })
            // }).catch(console.error.bind(console));
            // _this.getThousandNews(_this.conversationObj)
            // æ¶ˆæ¯æ¡†æ»šåˆ°æœ€åº•éƒ¨
            _this.scrollToBottom()
            // _this.getConversations(_this.initObj)
            // æ¸…ç©ºæ–‡ä»¶æ¡†ä»¥åŠè¾“å…¥æ¡†æ•°æ®
            _this.$refs.inputFile.value = null;//æ¸…æ¥šæ–‡ä»¶ä¸Šä¼ çš„valueè§£å†³é‡å¤ä¸Šä¼ åŒä¸€ä¸ªæ–‡ä»¶å¤±æ•ˆé—®é¢˜
            _this.fileObj=null
            _this.inputContent=''
          }).catch(console.error.bind(console));
        }
        // å‘é€æ–‡æœ¬ç±»å‹æ¶ˆæ¯
        if(this.inputContent.length>0&&!this.fileObj){
          this.conversationObj.send(new TextMessage(this.inputContent)).then(function(message) {
            console.log(message, 'æ–‡å­—å‘é€æˆåŠŸï¼');
            // å¦‚æœæˆå‘˜åˆ—è¡¨ä¸€å¼€å§‹è¿˜æ²¡æœ‰æ•°æ®
            if(_this.msgList.length==0){
              _this.menberList.push(_this.conversationObj)
            }
            _this.msgList.push(message)
            // æ›´æ–°æˆå‘˜åˆ—è¡¨ä¸­çš„æœ€åä¸€æ¡æ¶ˆæ¯
            _this.menberList.forEach((item,index)=>{
              if(item.id==_this.conversationObj.id){
                _this.$set(item,'lastMsg',message)
                console.warn(item,'æ–‡æœ¬ç±»å‹æœ€åä¸€æ¡æ¶ˆæ¯')
              }
            })
            // _this.conversationObj.queryMessages({
            //     limit: 1000, 
            // }).then((messages)=> {
            //   console.warn(messages[messages.length-1],'æœ€åä¸€æ¡æ–‡æœ¬æ¶ˆæ¯')
            //   _this.menberList.forEach((item,index)=>{
            //     if(item.id==_this.conversationObj.id){
            //       _this.$set(item,'lastMsg',messages[messages.length-1])
            //     }
            //   })
            // }).catch(console.error.bind(console));
            // _this.getThousandNews(_this.conversationObj)
            // æ¶ˆæ¯æ¡†æ»šåˆ°æœ€åº•éƒ¨
            _this.scrollToBottom()
            // _this.getConversations(_this.initObj)
            // æ¸…ç©ºè¾“å…¥æ¡†æ•°æ®
            _this.inputContent=''
          }).catch(console.error);
        }
      },
      // ç‚¹å‡»æœ€å°åŒ–åçš„èŠå¤©å°å›¾æ ‡é‡æ–°æ‰“å¼€èŠå¤©çª—å£
      returnChat(){
        this.isShowChat=true
        this.isMinWindow=false
        // èŠå¤©çª—ä½“ä¸€æ‰“å¼€ï¼Œé‚£é‡Œé¢çš„æ¶ˆæ¯å°±å…¨éƒ½æ ‡è®°ä¸ºå·²è¯»
        this.conversationObj.read().then(res=>{
          console.info(res,'æ ‡ä¸ºå·²è¯»')
        }).catch(err=>{console.error(err)})
        this.scrollToBottom()
      },
      // å…³é—­èŠå¤©å¯¹è¯æ¡†
      closeChatWindow(){
        this.showEmoji=false
        this.isShowChat=false
        this.isMinWindow=false
        document.querySelector('body').setAttribute('style', 'overflow-y:scroll')
        this.chattingMenbers=[]
      },
      // åˆ é™¤æ­£åœ¨èŠå¤©çš„å¥½å‹åˆ—è¡¨ä¸­çš„æŸä¸€ä¸ªæˆå‘˜
      delChatting(each,j){
        this.chattingMenbers.splice(j,1)
        if(each.id==this.curChatId){
          if(j==0){
            this.clickMenberList(this.chattingMenbers[0
            ])
          }else{
            this.clickMenberList(this.chattingMenbers[j-1])
          }
          // this.chatTo(undefined,this.chattingMenbers[j-1])
        }
        console.warn(each,'æŸä¸€é¡¹',j,'è¦åˆ é™¤çš„ä¸‹æ ‡',this.chattingMenbers,'æ­£åœ¨èŠå¤©çš„æˆå‘˜æ•°ç»„')
      },
      // æ‰“å¼€æˆ–è€…å…³é—­èŠå¤©å†å²è®°å½•æ¡†
      toggleHistory(){
        this.isShowHistory=!this.isShowHistory
        if(this.isShowHistory){
          this.isMinHistory=false
          // è·å–å†å²èŠå¤©è®°å½•
          var messageIterator = this.conversationObj.createMessagesIterator({ limit: 1000 });
          this.historyMsgList=[]
          this.historyIterator(messageIterator,this.conversationObj)

          // this.conversationObj.queryMessages({
          //   limit:1000
          // }).then((messages)=> {
          //   this.historyMsgList=[...messages]
          //   // æ»šåŠ¨åˆ°æœ€åº•éƒ¨
          //   this.$nextTick(()=>{
          //     this.$refs.historyMsg.scrollTo(0,this.$refs.historyMsg.scrollHeight)
          //   })
          // }).catch(console.error.bind(console));
        }
      },
      // æœ€å°åŒ–å†å²èŠå¤©è®°å½•æ¡†æˆå°æµ®çª—
      minHistory(){
        this.isShowHistory=false
        this.isMinHistory=true
      },
      // æœ€å¤§åŒ–å†å²èŠå¤©è®°å½•æ¡†
      maxHistory(){
        this.isMaxHistory=true
				document.querySelector('body').setAttribute('style', 'overflow:hidden')
      },
      // å–æ¶ˆæœ€å¤§åŒ–èŠå¤©å¯¹è¯æ¡†
      cancelMaxHistory(){
        this.isMaxHistory=false
				document.querySelector('body').setAttribute('style', 'overflow-y:scroll')
      },
      //å…³é—­å†å²è®°å½•æœ€å°åŒ–æµ®çª—
      closeMinHistory(){
        this.isMinHistory=false
      },
      // çª—å£æ‹–åŠ¨
      boxMove(ev) {
        if(this.isMaxWindow){
          return
        }
        var Odiv = document.getElementsByClassName('chat-window')[0]
        console.log('æŒ‰ä¸‹é¼ æ ‡',ev,'å·¦è¾¹',Odiv.offsetLeft)
        var disX = 0;
        var disY = 0;
        // å› ä¸ºfixedå®šä½çš„æ—¶å€™ç”¨äº†translate(-50%,-50%),æ‰€ä»¥è¦æ³¨æ„è¿™ä¸€éƒ¨åˆ†çš„å€¼
        var initX=Odiv.clientWidth/2
        var initY=Odiv.clientHeight/2
        // //é¼ æ ‡äº‹ä»¶å¯¹è±¡
        var oEvent = ev || event;
        disX = oEvent.clientX - Odiv.offsetLeft;
        disY = oEvent.clientY - Odiv.offsetTop;

        var _this=this

        document.onmousemove = function (ev) {
          // console.log('é¼ æ ‡æ‹–åŠ¨',ev)
            //é¼ æ ‡äº‹ä»¶å¯¹è±¡
            var oEvent = ev || event;
            var l = oEvent.clientX - disX;
            var t = oEvent.clientY - disY;

            if(l<initX){
              l=initX
            }else if(l>document.documentElement.clientWidth - Odiv.offsetWidth+initX){
              l=document.documentElement.clientWidth - Odiv.offsetWidth+initX
            }
            if(t<initY){
              t=initY
            }else if(t>document.documentElement.clientHeight - Odiv.offsetHeight+initY){
              t=document.documentElement.clientHeight - Odiv.offsetHeight+initY
            }
            Odiv.style.left = l+ "px";
            Odiv.style.top = t + "px";
            // é˜»æ­¢æ‹–æ‹½æ—¶å€™é€‰ä¸­æ–‡å­—
            // Odiv.setCapture&&Odiv.setCapture()
        }
        document.onmouseup = function (ev) {
          console.log('é¼ æ ‡æ¾å¼€',ev)
          document.onmousemove = null;
          document.onmouseup = null;
          // å–æ¶ˆé˜»æ­¢æ‹–æ‹½é€‰ä¸­æ–‡å­—
          // Odiv.releaseCapture&&Odiv.releaseCapture()
        }
        //é˜»æ­¢é»˜è®¤äº‹ä»¶
        return false;
      },
      // å…ƒç´ å¼€å§‹è¢«æ‹–åŠ¨
      startDrag(e){
        return
        console.warn(e,'å¼€å§‹æ‹–æ‹½')
        e.dataTransfer.setData("Text",e.target.id);//æµè§ˆå™¨å…¼å®¹
        this.initX=e.offsetX
        this.initY=e.offsetY
      },
      // æ¾å¼€é¼ æ ‡å…ƒç´ æ‹–æ”¾ç»“æŸ
      endDrag(e){
        return
        let x=e.offsetX-this.initX
        let y=e.offsetY-this.initY
        e.target.style.left=e.target.offsetLeft+x+'px'
        e.target.style.top=e.target.offsetTop+y+'px'
        console.warn(e.target.style.left,e,e.target.offsetLeft,'ll')
      },
      // å…ƒç´ æ­£åœ¨è¢«æ‹–åŠ¨
      dragging(e){
        return
        let x=e.offsetX-this.initX
        let y=e.offsetY-this.initY
        e.target.style.left=e.target.offsetLeft+x+'px'
        e.target.style.top=e.target.offsetTop+y+'px'
        // console.warn(e,'æ‹–æ‹½ä¸­')
      },
      // ç‚¹å‡»æ–‡ä»¶æ¶ˆæ¯ä¸»ä½“åœ¨å¦å¤–çª—å£æ‰“å¼€æ–‡ä»¶
      openUrl(){
        // window.open('http://img1.imgtn.bdimg.com/it/u=2357912857,682090914&fm=26&gp=0.jpg')
      },
      // é€‰æ‹©æ–‡ä»¶
      selectFile(e){
        console.warn(e.target.files,'æ–‡ä»¶',this.fileValue,'inputçš„å€¼')
        this.fileObj=e.target.files[0]
      },
      // åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶
      cancelFile(){
        this.fileObj=null
        this.$refs.inputFile.value = null;//æ¸…æ¥šæ–‡ä»¶ä¸Šä¼ çš„valueè§£å†³é‡å¤ä¸Šä¼ åŒä¸€ä¸ªæ–‡ä»¶å¤±æ•ˆé—®é¢˜
      },
      // æ—¶é—´æ ¼å¼å¤„ç†
      dealTime(val){
        var d = new Date(val);  
        var datetime=d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds(); 
        return datetime
      },
      // menberListæ’åºè§„åˆ™
      orderRule(a,b){
        if(a.unreadMessagesCount==b.unreadMessagesCount){
          return new Date(a._updateAt).getTime()-new Date(b._updateAt).getTime()
        }
        return a.unreadMessagesCount-b.unreadMessagesCount
      },
      // å¤´åƒè¿”å›æœ‰äº›å¸¦httpæœ‰äº›ä¸å¸¦æˆ‘ä¹Ÿå¾ˆæ— å¥ˆ
      picDeal(item){
        // console.warn(item,'item6666666666666')
        if(item.creator==this.user_data.id){
          // å¯¹è¯æ˜¯è‡ªå·±åˆ›å»ºçš„
          if(item._attributes.chatToObj){
            if(item._attributes.chatToObj.avatar){
              if(item._attributes.chatToObj.avatar.indexOf('http')==-1){
                return this.util.qiniuAddress+item._attributes.chatToObj.avatar
              }else{
                return item._attributes.chatToObj.avatar
              }
            }else{
              return 'https://pic.paitume.com/images/male.png'
            }
          }else{
            return 'https://pic.paitume.com/images/male.png'
          }
        }else{
          // å¯¹è¯æ˜¯å¯¹æ–¹åˆ›å»ºçš„
          if(item._attributes.creatorObj){
            if(item._attributes.creatorObj.avatar){
              if(item._attributes.creatorObj.avatar.indexOf('http')==-1){
                return this.util.qiniuAddress+item._attributes.creatorObj.avatar
              }else{
                return item._attributes.creatorObj.avatar
              }
            }else{
              return 'https://pic.paitume.com/images/male.png'
            }
          }else{
            return 'https://pic.paitume.com/images/male.png'
          }
        }
      },
      nameDeal(item){
        if(item.creator==this.user_data.id){
          // å¯¹è¯æ˜¯è‡ªå·±åˆ›å»ºçš„
          if(item._attributes.chatToObj){
            return item._attributes.chatToObj.name
          }else{
            return 'æ— åæ°'
          }
        }else{
          // å¯¹è¯æ˜¯å¯¹æ–¹åˆ›å»ºçš„
          if(item._attributes.creatorObj){
            return item._attributes.creatorObj.name
          }else{
            return 'æ— åæ°'
          }
        }
      },
      // æ“ä½œæ¶ˆæ¯æ¡†æ»šåŠ¨æ¡æ»šåŠ¨åˆ°åº•éƒ¨
      scrollToBottom(){
        if(this.isShowChat||this.isShowHistory){
          this.$nextTick(() => {
            let scrollEle = document.getElementsByClassName('message-box')[0] // è·å–å¯¹è±¡
            scrollEle.scrollTop = scrollEle.scrollHeight // æ»šåŠ¨é«˜åº¦
          })
        }
        // this.$nextTick(()=>{
        //   this.$refs.msgBox.scrollTo(0,this.$refs.msgBox.scrollHeight)
        // })
      },
      // è·å–æœ€æ–°1000æ¡æ¶ˆæ¯
      getThousandNews(conversation){
        console.warn('getThousandNews')

        // åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œæ¯æ¬¡è·å– 10 æ¡å†å²æ¶ˆæ¯
        var messageIterator = conversation.createMessagesIterator({ limit: 1000 });
        this.msgList=[]
        this.chatIterator(messageIterator,conversation)
        // ç¬¬ä¸€æ¬¡è°ƒç”¨ next æ–¹æ³•ï¼Œè·å¾—å‰ 10 æ¡æ¶ˆæ¯ï¼Œè¿˜æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œdone ä¸º false
        // messageIterator.next().then(function(result) {
          // result: {
          //   value: [message1, ..., message10],
          //   done: false,
          // }
        // }).catch(console.error.bind(console));
        // ç¬¬äºŒæ¬¡è°ƒç”¨ next æ–¹æ³•ï¼Œè·å¾—ç¬¬ 11~20 æ¡æ¶ˆæ¯ï¼Œè¿˜æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œdone ä¸º false
        // // è¿­ä»£å™¨å†…éƒ¨ä¼šè®°å½•èµ·å§‹æ¶ˆæ¯çš„æ•°æ®ï¼Œæ— éœ€å¼€å‘è€…æ˜¾ç¤ºæŒ‡å®š
        // messageIterator.next().then(function(result) {
        //   // result: {
        //   //   value: [message11, ..., message20],
        //   //   done: false,
        //   // }
        // }).catch(console.error.bind(console));

        // conversation.queryMessages({
        //     limit: 1000, // limit å–å€¼èŒƒå›´ 1~1000ï¼Œé»˜è®¤ 100
        // }).then((messages)=> {
        //   // æœ€æ–°çš„1000æ¡æ¶ˆæ¯,æŠŠå®ƒæ¨åˆ°messageListé‡Œé¢
        //   this.msgList=[...messages]
        //   this.$set(conversation,'lastMsg',messages[messages.length-1])
        //   this.hasNewMsg()
        //   // æ“ä½œæ»šåŠ¨æ¡æ»šåŠ¨åˆ°æœ€åº•éƒ¨
        //   this.scrollToBottom()
        // }).then(res=>{}).catch(console.error.bind(console));
      },
      // åˆ›å»ºè·å–æ¶ˆæ¯è®°å½•çš„è¿­ä»£å™¨ç”¨äºèŠå¤©window
      chatIterator(iterator,con){
        iterator.next().then(result=> {
          console.warn(result,'888')
          this.msgList.unshift(...result.value)
          if(!result.done){
            this.chatIterator(iterator,con)
          }else{
            this.isShowChat=true
            this.$set(con,'lastMsg',this.msgList[this.msgList.length-1])
            this.hasNewMsg()
            // æ“ä½œæ»šåŠ¨æ¡æ»šåŠ¨åˆ°æœ€åº•éƒ¨
            this.scrollToBottom()
          }
        }).catch(console.error.bind(console))
      },
      // åˆ›å»ºè·å–æ¶ˆæ¯è®°å½•çš„è¿­ä»£å™¨ç”¨äºå†å²è®°å½•
      historyIterator(iterator,con,flag){
        iterator.next().then(result=> {
          this.historyMsgList.unshift(...result.value)
          if(!result.done){
            this.historyIterator(iterator,con)
          }else{
              // æ»šåŠ¨åˆ°æœ€åº•éƒ¨
            this.$nextTick(()=>{
              this.$refs.historyMsg.scrollTo(0,this.$refs.historyMsg.scrollHeight)
            })
            if(flag==1){
              return
            }
            this.isShowHistory=true
          }
        }).catch(console.error.bind(console))
      }
    }
  }
</script>

<style lang="scss" scoped>
.chat-wrap{
  .enter{
    position: fixed;
    bottom: 5px;
    right: 5px;
    width: 40px;
    height: 40px;
    // line-height: 50px;
    // text-align: center;
    border-radius: 2px;
    box-shadow: 1px 1px 50px rgba(0,0,0,.3);
    z-index: 990;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.5s;
    background: #7C6AFF;
    i{
      font-size: 25px;
      animation-duration: 3s;
      animation-iteration-count: infinite;
      color: #fff;
      position: relative;
      &:after{
        visibility: hidden;
        content:'';
        background: red;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        position: absolute;
        right: 0;
      }
    }
    .new{
      &:after{
        visibility: visible;
      }
    }
    &:hover{
      width: 100px;
      height: 50px;
      i{
        visibility: visible;
        font-size: 35px;
      }
    }
  }
  .menbers-list-wrap{
    background: red;
    width: 260px;
    height: 520px;
    position: fixed;
    bottom: 0;
    right: 0;
    z-index: 991;
    border-radius: 2px;
    box-shadow: 1px 1px 50px rgba(0,0,0,.3);
    display: flex;
    flex-direction: column;
    .person-info{
      height: 110px;
      height: 70px;
      background: rgb(214,214,214);
      padding: 20px;
      box-sizing: border-box;
      background: #7C6AFF;
      color: #fff;
      .first-row{
        display: flex;
        justify-content: space-between;
        .my-name{
          font-size: 18px;
          // color: #7C6AFF;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
        }
        .el-icon-circle-close{
          font-size: 26px;
          cursor: pointer;
          &:hover{
            // color: #7C6AFF;
            color: red;
          }
        }
      }
    }
    .menbers-list{
      flex: 1;
      padding-left: 20px;
      padding-top: 10px;
      padding: 10px 0 20px 0;
      box-sizing: border-box;
      overflow-y: auto;
      background: #fff;
      /*ä¿®æ”¹æ»šåŠ¨æ¡æ ·å¼*/
      &::-webkit-scrollbar{
        width:10px;
        height:10px;
        /**/
      }
      &::-webkit-scrollbar-track{
        background: rgb(239, 239, 239);
        border-radius:2px;
      }
      &::-webkit-scrollbar-thumb{
        background: rgb(214, 214, 214);
        // background: #bfbfbf;
        border-radius:10px;
      }
      &::-webkit-scrollbar-thumb:hover{
        background: rgb(124,106,255);
      }
      &::-webkit-scrollbar-corner{
        background: #179a16;
      }
      .menber-wrap{
        .menber{
          padding:0 20px;
          box-sizing: border-box;
          height: 52px;
          display: flex;
          cursor: pointer;
          &:hover{
            background: #eee;
          }
          &+.menber{
            margin-top: 8px;
          }
          .menber-left{
            display: flex;
            align-items: center;
            height: 100%;
            margin-right: 20px;
            img{
              width: 40px;
              height: 40px;
              border-radius: 50%;
              border: 1px solid #7C6AFF;
            }
          }
          .menber-right{
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            margin-right: auto;
            .last-msg{
              color: #777;
              overflow: hidden;
              white-space: nowrap;
              text-overflow: ellipsis;
            }
          }
          .new-count{
            align-self: center;
            background: red;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
          }
        }
      }
      .no-menber{
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 16px;
        color: #7C6AFF;
      }
    }
  }
  .chat-window{
    min-width: 700px;
    min-height: 626px;
    border: 1px solid #D9D9D9;
    border-color: rgba(0,0,0,.05);
    // background-color: #F6F6F6;
    background: rgb(251,251,251);
    color: #333;
    border-radius: 2px;
    box-shadow: 1px 1px 50px rgba(0,0,0,.3);
    // position: absolute;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    z-index: 9999;
    display: flex;
    // flex-direction: column;

    .window-left{
      width: 200px;
      background: rgb(217,217,217);
      padding: 8px;
      box-sizing: border-box;
      overflow-y: auto;
      .chat-menber{
        display: flex;
        align-items: center;
        cursor: pointer;
        height: 50px;
        padding: 0 8px;
        box-sizing: border-box;
        border-radius: 4px;
        margin-bottom: 8px;
        &:hover{
          background: rgb(226,226,226);
          i{
            display: block;
          }
        }
        img{
          width: 40px;
          height: 40px;
          border-radius: 50%;
          margin-right: 16px;
        }
        .menber-name{
          font-size: 16px;
          margin-right: auto;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
        }
        i{
          font-size: 18px;
          display: none;
        }
      }
      .chat-menber-checked{
        background: rgb(243,243,243);
        &:hover{
          background: rgb(243,243,243);
        }
      }
    }
    .window-right{
      min-width: 700px;
      flex: 1;
      display: flex;
      flex-direction: column;
      padding-bottom: 12px;
      box-sizing: border-box;
      .chat-top{
        height: 80px;
        background: rgb(236,236,236);
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        justify-content: space-between;
        cursor: move;
        .menber-info{
          display: flex;
          img{
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 20px;
          }
          .menber-name{
            font-size: 20px;
            padding-top: 6px;
            box-sizing: border-box;
          }
        }
        .window-operation{
          i{
            font-size: 20px;
            cursor: pointer;
          }
          i:not(:last-child){
            margin-right: 10px;
          }
        }
      }
      .message-box{
        // height: 375px;
        height: 420px;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        // background: rgb(251,251,251);
        .message{
          display: flex;
          margin-bottom: 10px;
          .avatar{
            width: 40px;
            height: 40px;
            margin-right: 20px;
            border-radius: 50%;
          }
          .msg-body{
            // display: flex;
            // flex-direction: column;
            .name-time{
              // display: flex;
              // justify-content: space-between;
              margin-bottom: 6px;
              color: #999;
              .name{
                margin-right: 14px;
              }
            }
            .content{
              padding: 8px 16px;
              box-sizing: border-box;
              background: #e2e2e2;
              color: #333;
              display: inline-block;
              border-radius: 4px;
              position: relative;
              max-width: 500px;
              word-wrap: break-word;
              text-align: left;
              line-height: 22px;
              font-size: 16px;
              letter-spacing: 2px;
              &:before{
                content: "";
                width: 0;
                height: 0;
                position: absolute;
                left: 0;
                top: 10px;
                transform: translateX(-50%);
                border-bottom: 10px transparent dashed;
                border-left: 10px transparent dashed;
                border-right: 10px transparent dashed;
                border-top: 10px solid rgb(95,184,120);
                border-top:10px solid #e2e2e2;
              }
              .file{
                display: flex;
                flex-direction: column;
                .file-link{
                  text-align: center;
                  img{
                    width: 160px;
                    height: 120px;
                    cursor: pointer;
                  }
                  video{
                    min-width: 300px;
                    height: 200px;
                  }
                  .el-icon-document{
                    font-size: 40px;
                    margin: 0 auto;
                  }
                  a{
                    display: block;
                    margin:5px auto;
                    width: 200px;
                    overflow: hidden;
                  }
                }
                .decription{}
              }
            }
          }
        }
        .my-message{
          flex-direction: row-reverse;
          .avatar{
            margin-left: 20px;
          }
          .msg-body{
            text-align: right;
            .name-time{
              display: flex;
              flex-direction: row-reverse;
              .name{
                margin-left: 14px;
                margin-right: 0;
              }
              .time{
                display: flex;
                align-items: flex-end;
              }
            }
            .content{
              // background: rgb(95,184,120);
              background: #7C6AFF;
              color: #fff;
              &:after{
                content: "";
                width: 0;
                height: 0;
                position: absolute;
                right: 0;
                top: 10px;
                transform: translateX(50%);
                border-bottom: 10px transparent dashed;
                border-left: 10px transparent dashed;
                border-right: 10px transparent dashed;
                // border-top: 10px solid rgb(95,184,120);
                border-top: 10px solid #7C6AFF;
              }
              &:before{
                all:unset;
              }
            }
          }
        }
      }
      .max-message-box{
        height: calc(100% - 260px);
      }
      .send-operation{
        height: 40px;
        border-top: 1px solid #D9D9D9;
        display: flex;
        // justify-content: space-between;
        align-items: center;
        padding:0 26px;
        box-sizing: border-box;
        background: rgb(251,251,251);
        .send-file{
          position: relative;
          display: inline-block;
          overflow: hidden;
          margin-right: 30px;
          input{
            position: absolute;
            right: 0px;
            top: 0px;
            opacity: 0;
            cursor: pointer;
            // -ms-filter: 'alpha(opacity=0)';
          }
          .el-icon-folder-opened{
            font-size: 24px;
          }
        }
        .emoji-wrap{
          position: relative;
          &>span{
            cursor: pointer;
          }
          .emoji-box{
            background: #fff;
            position: absolute;
            width: 350px;
            height: 200px;
            z-index: 9999;
            transform: translate(-10%,-123%);
            overflow-y: auto; 
            padding: 10px;
            box-sizing: border-box;
            box-shadow:0px 0px 5px 3px #ddd;
            .emoji-group{
              margin-bottom: 15px;
              .emoji-class{
                margin-bottom: 10px;
              }
              .emoji-list{
                display: flex;
                flex-wrap: wrap;
                .emoji-item{
                  cursor: pointer;
                  width: 30px;
                  height: 30px;
                  // border: 1px solid #000;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  &:hover{
                    background: #ddd;
                  }
                }
              }
            }
          }
        }
        .history-label{
          display: flex;
          align-items: center;
          cursor: pointer;
          margin-left: auto;
          .el-icon-time{
            font-size: 22px;
            margin-right: 6px;
            cursor: pointer;
          }
        }
        .file-info{
          display: flex;
          align-items: center;
          .file-name{
            margin-right: 16px;
            color: #7C6AFF;
          }
          .cancel-btn{
            padding: 5px 10px;
            background: #7C6AFF;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
          }
          i{
            font-size: 16px;   
            cursor: pointer;
          }
        }
      }
      .input-area{
        // flex: 1;
        padding-bottom: 6px;
        box-sizing: border-box;
        /deep/{
          .el-textarea{
            height: 100%;
            .el-textarea__inner{
              resize: none;
              border-radius: 0;
              height: 100px;
              border: none;
              background: rgb(251,251,251);
            }
          }
        }
      }
      .bottom-btn{
        height: 40px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-right: 20px;
        box-sizing: border-box;
        // background: rgb(251,251,251);
        span{
          margin-left: 15px;
          padding: 10px 20px;
          // background-color: #69BC80;
          background: #7C6AFF;
          border-radius: 3px;
          color: #fff;
          cursor: pointer;
        }
      }
    }
  }
  .max-window{
    width: 100%;
    height: 100%;
  }
  .small-chat{
    width: 184px;
    height: 52px;
    border-radius: 2px;
    background: #fff;
    box-shadow: 1px 1px 50px rgba(0,0,0,.3);
    z-index: 9999;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    padding:0 13px;
    box-sizing: border-box;
    cursor: pointer;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    img{
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .menber-name{
      font-size: 18px;
      flex: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
  }
  .history-box{
    width: 550px;
    height: 100%;
    position: fixed;
    right: 0;
    top: 0;
    z-index: 99999;
    border: 1px solid rgba(0,0,0,.1);
    box-shadow: 1px 1px 5px rgba(0,0,0,.2);
    background: #fff;
    animation-duration: 0.5s;
    // animation-delay: 2s;
    .history-top{
      height: 46px;
      background: rgb(248,248,248);
      display: flex;
      align-items: center;
      padding:0 20px;
      box-sizing: border-box;
      span{
        margin-right: auto;
        font-size: 16px;
      }
      i{
        font-size: 20px;
        cursor: pointer;
      }
      i+i{
        margin-left: 12px;
      }
    }
    .history-message-box{
      // height: 375px;
      height: calc(100% - 46px);
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      // background: rgb(251,251,251);
      /*ä¿®æ”¹æ»šåŠ¨æ¡æ ·å¼*/
      &::-webkit-scrollbar{
        width:10px;
        height:10px;
        /**/
      }
      &::-webkit-scrollbar-track{
        background: rgb(239, 239, 239);
        border-radius:2px;
      }
      &::-webkit-scrollbar-thumb{
        background: rgb(214, 214, 214);
        // background: #bfbfbf;
        border-radius:10px;
      }
      &::-webkit-scrollbar-thumb:hover{
        background: #333;
      }
      &::-webkit-scrollbar-corner{
        background: #179a16;
      }
      .tip{
        text-align: center;
        margin-bottom: 20px;
        font-size: 16px;
        color: #7C6AFF;
      }
      .message{
        display: flex;
        margin-bottom: 10px;
        .avatar{
          width: 40px;
          height: 40px;
          margin-right: 20px;
        }
        .msg-body{
          // display: flex;
          // flex-direction: column;
          .name-time{
            // display: flex;
            // justify-content: space-between;
            margin-bottom: 6px;
            color: #999;
            .name{
              margin-right: 14px;
            }
          }
          .content{
            padding: 8px 16px;
            box-sizing: border-box;
            background: #e2e2e2;
            color: #333;
            display: inline-block;
            border-radius: 4px;
            position: relative;
            max-width: 500px;
            word-wrap: break-word;
            text-align: left;
            line-height: 22px;
            font-size: 16px;
            letter-spacing: 2px;
            &:before{
              content: "";
              width: 0;
              height: 0;
              position: absolute;
              left: 0;
              top: 10px;
              transform: translateX(-50%);
              border-bottom: 10px transparent dashed;
              border-left: 10px transparent dashed;
              border-right: 10px transparent dashed;
              border-top: 10px solid rgb(95,184,120);
              border-top:10px solid #e2e2e2;
            }
            .file{
              display: flex;
              flex-direction: column;
              .file-link{
                text-align: center;
                img{
                  width: 160px;
                  height: 120px;
                  cursor: pointer;
                }
                video{
                  width: 200px;
                  height: 130px;
                }
                audio{
                  width: 300px;
                  height: 60px;
                }
                .el-icon-document{
                  font-size: 40px;
                  margin: 0 auto;
                }
                a{
                  // display: flex;
                  // justify-content: center;
                  display: block;
                  margin:5px auto;
                  width: 200px;
                }
              }
              .decription{}
            }
          }
        }
      }
      .my-message{
        flex-direction: row-reverse;
        .avatar{
          margin-left: 20px;
        }
        .msg-body{
          text-align: right;
          .name-time{
            display: flex;
            flex-direction: row-reverse;
            .name{
              margin-left: 14px;
              margin-right: 0;
            }
            .time{
              display: flex;
              align-items: flex-end;
            }
          }
          .content{
            // background: rgb(95,184,120);
            background: #7C6AFF;
            color: #fff;
            &:after{
              content: "";
              width: 0;
              height: 0;
              position: absolute;
              right: 0;
              top: 10px;
              transform: translateX(50%);
              border-bottom: 10px transparent dashed;
              border-left: 10px transparent dashed;
              border-right: 10px transparent dashed;
              // border-top: 10px solid rgb(95,184,120);
              border-top: 10px solid #7C6AFF;
            }
            &:before{
              all:unset;
            }
          }
        }
      }
    }
  }
  .max-history{
    width: 100%;
    height: 100%;
  }
  .small-history{
    width: 180px;
    height: 50px;
    position: fixed;
    left: 0;
    bottom: 0;
    z-index: 999999;
    display: flex;
    align-items: center;
    background: #f8f8f8;
    padding: 0 20px;
    box-sizing: border-box;
    border-radius: 2px;
    box-shadow: 1px 1px 50px rgba(0,0,0,.3);
    span{
      margin-right: auto;
      font-size: 16px;
    }
    i{
      cursor: pointer;
      font-size: 18px;
    }
    .el-icon-copy-document{
      margin-right: 12px;
    }
  }
}
</style>